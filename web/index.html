<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title>MADOLA - Math Domain Language Editor</title>
    <link rel="stylesheet" href="css/madola-output.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/print.css">
    <script>
        window.MathJax = {
            tex: {
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                processEscapes: true,
                processEnvironments: true,
                packages: {'[+]': ['ams', 'newcommand', 'configmacros']}
            },
            chtml: {
                scale: 1.0,
                displayAlign: 'left'
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            startup: {
                ready: () => {
                    console.log('MathJax startup ready');
                    window.MathJax.startup.defaultReady();
                }
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"
            onerror="console.error('Failed to load D3.js from jsdelivr'); loadD3Fallback();"></script>
    <script type="module">
        // Load Three.js as ES module to avoid deprecation warnings
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
        window.THREE = THREE;
        console.log('Three.js loaded as ES module');
    </script>
    <script>
        // Fallback for Three.js if ES modules fail
        if (typeof window.THREE === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js';
            script.onload = () => console.log('Three.js loaded via fallback');
            script.onerror = () => console.error('Failed to load Three.js');
            document.head.appendChild(script);
        }
    </script>
    <script>
        // Configure Monaco Environment before loading
        window.MonacoEnvironment = {
            getWorkerUrl: function(moduleId, label) {
                return `data:text/javascript;charset=utf-8,${encodeURIComponent(`
                    self.MonacoEnvironment = {
                        baseUrl: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/'
                    };
                    importScripts('https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/base/worker/workerMain.js');
                `)}`;
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <script>
        // Load Monaco Editor using its AMD loader
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            console.log('Monaco Editor loaded successfully');
            // Disable AMD after Monaco loads to prevent conflicts with other libraries
            window.define = undefined;
            window.require = undefined;
        });
    </script>
    <script>
        function loadD3Fallback() {
            console.log('Loading D3.js fallback...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/d3@7/dist/d3.min.js';
            script.onerror = function() {
                console.error('D3.js fallback also failed');
                window.d3LoadError = true;
            };
            script.onload = function() {
                console.log('D3.js loaded successfully via fallback');
                window.d3 = d3;
            };
            document.head.appendChild(script);
        }

        // Check if D3 is loaded after page load
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (typeof window.d3 === 'undefined' && typeof d3 === 'undefined') {
                    console.error('D3.js not loaded - trying fallback');
                    loadD3Fallback();
                } else {
                    // Ensure D3 is available on window object
                    if (typeof d3 !== 'undefined' && typeof window.d3 === 'undefined') {
                        window.d3 = d3;
                    }
                    console.log('D3.js loaded successfully:', typeof window.d3);
                }
            }, 500);
        });
    </script>
    <script src="js/madola-browser.js"></script>
    <script src="js/madola-language.js"></script>
</head>
<body>
    <div id="app">
        <!-- Top Menu Bar -->
        <header class="menubar">
            <div class="menubar-left">
                <div class="menubar-brand">
                    <span class="brand-icon" aria-label="MADOLA logo">
                        <svg viewBox="0 0 512 512" role="img" aria-hidden="true">
                            <defs>
                                <linearGradient id="inline-bg" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#0F2658"/>
                                    <stop offset="100%" stop-color="#041330"/>
                                </linearGradient>
                                <linearGradient id="inline-stroke" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" stop-color="#7FDBFF"/>
                                    <stop offset="100%" stop-color="#2D7CE6"/>
                                </linearGradient>
                            </defs>
                            <rect x="24" y="24" width="464" height="464" rx="112" fill="url(#inline-bg)"/>
                            <path d="M140 320 V120 L256 280 L372 120 V320"
                                  fill="none"
                                  stroke="url(#inline-stroke)"
                                  stroke-width="44"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"/>
                            <text x="256" y="440"
                                  font-family="Inter, 'Segoe UI', 'Helvetica Neue', sans-serif"
                                  font-size="72"
                                  font-weight="700"
                                  text-anchor="middle"
                                  letter-spacing="10"
                                  fill="#E6F2FF">
                                MADOLA
                            </text>
                        </svg>
                    </span>
                    <div class="brand-text">
                        <span class="brand-name">MADOLA</span>
                        <span class="brand-tagline">Math Domain Language Studio</span>
                    </div>
                </div>
                <div class="menu-section menubar-actions">
                    <button id="btn-new" class="menu-btn">
                        <span class="btn-icon">üìÑ</span>
                        New
                    </button>
                    <button id="btn-open" class="menu-btn">
                        <span class="btn-icon">üìÅ</span>
                        Open
                    </button>
                    <button id="btn-save" class="menu-btn">
                        <span class="btn-icon">üíæ</span>
                        Save
                    </button>
                    <button id="btn-save-as" class="menu-btn">
                        <span class="btn-icon">üìã</span>
                        Save As
                    </button>
                </div>
            </div>
            <div class="menubar-right">
                <button id="theme-toggle-btn" class="menu-btn menu-btn--icon theme-toggle-btn" title="Toggle Light/Dark Mode">
                    <span class="theme-toggle-icon">‚òÄÔ∏è</span>
                </button>
                <div class="menubar-status">
                    <span class="status-dot"></span>
                    <span class="status-label">Ready</span>
                </div>
                <div class="menu-section menu-section--compact">
                    <button id="btn-about" class="menu-btn menu-btn--subtle">
                        <span class="btn-icon">‚ÑπÔ∏è</span>
                        About
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Container -->
        <main class="main-container">
            <!-- Left Sidebar Panel -->
            <div class="sidebar-panel left-sidebar">
                <!-- Icon Bar (Always Visible) -->
                <div class="sidebar-icon-bar">
                    <div class="sidebar-header">
                        <button id="btn-toggle-sidebar" class="sidebar-toggle-btn" title="Toggle Content Panel">‚ò∞</button>
                    </div>
                    <div class="sidebar-tabs">
                        <button class="sidebar-tab active" data-tab="input" title="Input Tools">
                            <span class="tab-icon">üìù</span>
                        </button>
                        <button class="sidebar-tab" data-tab="messages" title="Messages">
                            <span class="tab-icon">üí¨</span>
                        </button>
                        <button class="sidebar-tab" data-tab="files" title="Files">
                            <span class="tab-icon">üìÇ</span>
                        </button>
                        <button class="sidebar-tab" data-tab="ai" title="AI Assistant">
                            <span class="tab-icon">‚ú®</span>
                        </button>
                        <button class="sidebar-tab" data-tab="settings" title="Settings">
                            <span class="tab-icon">‚öôÔ∏è</span>
                        </button>
                    </div>
                </div>

                <!-- Content Panel (Expandable) -->
                <div class="sidebar-content-panel" id="sidebar-content-panel">
                    <div class="sidebar-content">
                        <!-- Input Tab -->
                        <div class="sidebar-tab-content active" id="sidebar-input">
                            <div class="sidebar-content-header">
                                <h3>Input Tools</h3>
                            </div>
                            <div class="formatting-toolbar">
                                <h4>Formatting</h4>
                                <div class="toolbar-buttons">
                                    <button class="format-btn" data-format="bold" title="Bold"><strong>B</strong></button>
                                    <button class="format-btn" data-format="italic" title="Italic"><em>I</em></button>
                                </div>
                                <h4>Heading and Paragraph</h4>
                                <div class="toolbar-buttons">
                                    <button class="format-btn" data-format="h1" title="Heading 1">H1</button>
                                    <button class="format-btn" data-format="h2" title="Heading 2">H2</button>
                                    <button class="format-btn" data-format="h3" title="Heading 3">H3</button>
                                    <button class="format-btn" data-format="h4" title="Heading 4">H4</button>
                                    <button class="format-btn" data-format="p" title="Paragraph">P</button>
                                </div>
                                <h4>Alignment</h4>
                                <div class="toolbar-buttons">
                                    <button class="format-btn" data-format="align-left" title="Align Left">‚¨Ö</button>
                                    <button class="format-btn" data-format="align-center" title="Align Center">‚Üî</button>
                                    <button class="format-btn" data-format="align-right" title="Align Right">‚û°</button>
                                </div>
                            </div>
                            <div class="greek-symbols">
                                <h4>Greek Letters (Lowercase)</h4>
                                <div class="symbol-grid-compact">
                                    <button class="symbol-btn-sm" data-latex="\alpha">Œ±</button>
                                    <button class="symbol-btn-sm" data-latex="\beta">Œ≤</button>
                                    <button class="symbol-btn-sm" data-latex="\gamma">Œ≥</button>
                                    <button class="symbol-btn-sm" data-latex="\delta">Œ¥</button>
                                    <button class="symbol-btn-sm" data-latex="\epsilon">Œµ</button>
                                    <button class="symbol-btn-sm" data-latex="\zeta">Œ∂</button>
                                    <button class="symbol-btn-sm" data-latex="\eta">Œ∑</button>
                                    <button class="symbol-btn-sm" data-latex="\theta">Œ∏</button>
                                    <button class="symbol-btn-sm" data-latex="\iota">Œπ</button>
                                    <button class="symbol-btn-sm" data-latex="\kappa">Œ∫</button>
                                    <button class="symbol-btn-sm" data-latex="\lambda">Œª</button>
                                    <button class="symbol-btn-sm" data-latex="\mu">Œº</button>
                                    <button class="symbol-btn-sm" data-latex="\nu">ŒΩ</button>
                                    <button class="symbol-btn-sm" data-latex="\xi">Œæ</button>
                                    <button class="symbol-btn-sm" data-latex="\omicron">Œø</button>
                                    <button class="symbol-btn-sm" data-latex="\pi">œÄ</button>
                                    <button class="symbol-btn-sm" data-latex="\rho">œÅ</button>
                                    <button class="symbol-btn-sm" data-latex="\sigma">œÉ</button>
                                    <button class="symbol-btn-sm" data-latex="\tau">œÑ</button>
                                    <button class="symbol-btn-sm" data-latex="\upsilon">œÖ</button>
                                    <button class="symbol-btn-sm" data-latex="\phi">œÜ</button>
                                    <button class="symbol-btn-sm" data-latex="\chi">œá</button>
                                    <button class="symbol-btn-sm" data-latex="\psi">œà</button>
                                    <button class="symbol-btn-sm" data-latex="\omega">œâ</button>
                                </div>
                                <h4>Greek Letters (Uppercase)</h4>
                                <div class="symbol-grid-compact">
                                    <button class="symbol-btn-sm" data-latex="\Alpha">Œë</button>
                                    <button class="symbol-btn-sm" data-latex="\Beta">Œí</button>
                                    <button class="symbol-btn-sm" data-latex="\Gamma">Œì</button>
                                    <button class="symbol-btn-sm" data-latex="\Delta">Œî</button>
                                    <button class="symbol-btn-sm" data-latex="\Epsilon">Œï</button>
                                    <button class="symbol-btn-sm" data-latex="\Zeta">Œñ</button>
                                    <button class="symbol-btn-sm" data-latex="\Eta">Œó</button>
                                    <button class="symbol-btn-sm" data-latex="\Theta">Œò</button>
                                    <button class="symbol-btn-sm" data-latex="\Iota">Œô</button>
                                    <button class="symbol-btn-sm" data-latex="\Kappa">Œö</button>
                                    <button class="symbol-btn-sm" data-latex="\Lambda">Œõ</button>
                                    <button class="symbol-btn-sm" data-latex="\Mu">Œú</button>
                                    <button class="symbol-btn-sm" data-latex="\Nu">Œù</button>
                                    <button class="symbol-btn-sm" data-latex="\Xi">Œû</button>
                                    <button class="symbol-btn-sm" data-latex="\Omicron">Œü</button>
                                    <button class="symbol-btn-sm" data-latex="\Pi">Œ†</button>
                                    <button class="symbol-btn-sm" data-latex="\Rho">Œ°</button>
                                    <button class="symbol-btn-sm" data-latex="\Sigma">Œ£</button>
                                    <button class="symbol-btn-sm" data-latex="\Tau">Œ§</button>
                                    <button class="symbol-btn-sm" data-latex="\Upsilon">Œ•</button>
                                    <button class="symbol-btn-sm" data-latex="\Phi">Œ¶</button>
                                    <button class="symbol-btn-sm" data-latex="\Chi">Œß</button>
                                    <button class="symbol-btn-sm" data-latex="\Psi">Œ®</button>
                                    <button class="symbol-btn-sm" data-latex="\Omega">Œ©</button>
                                </div>
                            </div>
                        </div>

                        <!-- Messages Tab -->
                        <div class="sidebar-tab-content" id="sidebar-messages">
                            <div class="sidebar-content-header">
                                <h3>Messages</h3>
                            </div>
                            <div class="progress-header">
                                <button id="btn-clear-sidebar-messages" class="clear-btn">Clear All</button>
                            </div>
                            <div id="sidebar-messages-container" class="messages-container"></div>
                        </div>

                        <!-- Files Tab -->
                        <div class="sidebar-tab-content" id="sidebar-files">
                            <div class="sidebar-content-header">
                                <h3>Files</h3>
                                <button id="refresh-files-btn" class="refresh-btn" title="Refresh Files">üîÑ</button>
                            </div>
                            
                            <!-- C++ Files Section -->
                            <div class="file-section">
                                <div class="section-header" id="cpp-section-header">
                                    <span class="toggle-icon">‚ñº</span>
                                    <span class="section-title">üìÑ Generated C++</span>
                                </div>
                                <div class="file-list" id="cpp-file-list">
                                    <div class="file-item empty">Loading...</div>
                                </div>
                            </div>

                            <!-- WASM Modules Section -->
                            <div class="file-section">
                                <div class="section-header" id="wasm-section-header">
                                    <span class="toggle-icon">‚ñº</span>
                                    <span class="section-title">üîß WASM Modules</span>
                                </div>
                                <div class="file-list" id="wasm-module-list">
                                    <div class="file-item empty">Loading...</div>
                                </div>
                            </div>
                        </div>

                        <!-- AI Tab -->
                        <div class="sidebar-tab-content" id="sidebar-ai">
                            <div class="sidebar-content-header">
                                <h3>AI Assistant</h3>
                            </div>
                            <div class="ai-placeholder">
                                <p>AI dialog feature coming soon...</p>
                            </div>
                        </div>

                        <!-- Settings Tab -->
                        <div class="sidebar-tab-content" id="sidebar-settings">
                            <div class="sidebar-content-header">
                                <h3>Settings</h3>
                            </div>
                            <div class="settings-content">
                                <div class="setting-item">
                                    <label>Color Theme</label>
                                    <div class="color-theme-buttons">
                                        <button class="color-theme-btn active" data-color="blue" title="Blue" style="background: #3498db;"></button>
                                        <button class="color-theme-btn" data-color="green" title="Green" style="background: #27ae60;"></button>
                                        <button class="color-theme-btn" data-color="purple" title="Purple" style="background: #9b59b6;"></button>
                                        <button class="color-theme-btn" data-color="orange" title="Orange" style="background: #e67e22;"></button>
                                        <button class="color-theme-btn" data-color="red" title="Red" style="background: #e74c3c;"></button>
                                        <button class="color-theme-btn" data-color="teal" title="Teal" style="background: #1abc9c;"></button>
                                        <button class="color-theme-btn" data-color="pink" title="Pink" style="background: #e91e63;"></button>
                                        <button class="color-theme-btn" data-color="indigo" title="Indigo" style="background: #3f51b5;"></button>
                                        <button class="color-theme-btn" data-color="cyan" title="Cyan" style="background: #00bcd4;"></button>
                                        <button class="color-theme-btn" data-color="lime" title="Lime" style="background: #8bc34a;"></button>
                                        <button class="color-theme-btn" data-color="amber" title="Amber" style="background: #ffc107;"></button>
                                        <button class="color-theme-btn" data-color="brown" title="Brown" style="background: #795548;"></button>
                                        <button class="color-theme-btn" data-color="navy" title="Navy" style="background: #34495e;"></button>
                                        <button class="color-theme-btn" data-color="crimson" title="Crimson" style="background: #dc143c;"></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- About Tab -->
                        <div class="sidebar-tab-content" id="sidebar-about">
                            <div class="sidebar-content-header">
                                <h3>About MADOLA</h3>
                            </div>
                            <div class="about-content">
                                <p><strong>MADOLA</strong> (Math Domain Language) is a specialized language for mathematical computations and documentation.</p>
                                <p><strong>Version:</strong> 1.0.0</p>
                                <p><strong>Features:</strong></p>
                                <ul>
                                    <li>Function definitions</li>
                                    <li>Mathematical expressions</li>
                                    <li>LaTeX rendering</li>
                                    <li>C++ code generation</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resize Handle for Left Sidebar -->
            <div class="resize-handle hidden" id="resize-left"></div>

            <!-- Middle Panel (Editor) -->
            <div class="panel middle-panel">
                <div class="panel-header">
                    <div class="example-selector">
                        <select id="example-dropdown" class="example-select">
                            <option value="">Select Example...</option>
                            <option value="example.mda">Basic Example</option>
                            <option value="quadratic_solver.mda">Quadratic Equation Solver</option>
                            <option value="calculate_pi.mda">Calculate Pi (Leibniz)</option>
                            <option value="gcd.mda">GCD (Euclidean Algorithm)</option>
                            <option value="factorial.mda">Factorial Function</option>
                            <option value="trigonometry.mda">Trigonometric Functions</option>
                            <option value="matrix_vector.mda">Matrix-Vector Operations</option>
                            <option value="summation.mda">Summation</option>
                            <option value="piecewise.mda">Piecewise Functions</option>
                            <option value="for_loop.mda">For Loop</option>
                            <option value="string_concat.mda">String Concatenation</option>
                            <option value="units.mda">Physical Units</option>
                            <option value="latex_variables.mda">LaTeX Variables</option>
                            <option value="decorators.mda">Decorators</option>
                            <option value="brick_3d.mda">3D Brick with Hole</option>
                            <option value="graph_3d.mda">3D Graphs</option>
                        </select>
                    </div>
                    <div class="editor-controls">
                        <button id="btn-run" class="control-btn primary">Run</button>
                    </div>
                </div>
                <div class="monaco-container">
                    <div id="monaco-editor"></div>
                </div>
            </div>

            <!-- Resize Handle for Right Panel -->
            <div class="resize-handle" id="resize-right"></div>

            <!-- Right Panel (Output) -->
            <div class="panel right-panel">
                <div class="panel-header">
                    <div class="tab-container">
                        <button id="tab-output" class="tab-btn active">PDF Output</button>
                        <button id="tab-cpp" class="tab-btn">C++ Files</button>
                    </div>
                    <div class="output-controls">
                        <button id="btn-copy-output" class="control-btn primary">Copy</button>
                        <button id="btn-download-html" class="control-btn primary">Download</button>
                        <button id="btn-print-pdf" class="control-btn primary">Download PDF</button>
                    </div>
                </div>

                <!-- Output Tab Content -->
                <div id="output-content" class="tab-content active">
                    <div id="output" class="output-container">
                        <div class="output-placeholder">
                            <p>Run your MADOLA code to see the formatted output here.</p>
                            <p>Math expressions will be rendered with MathJax.</p>
                        </div>
                    </div>
                </div>

                <!-- C++ Files Tab Content -->
                <div id="cpp-content" class="tab-content">
                    <div class="cpp-files-container">
                        <div class="cpp-files-sidebar">
                            <h4>Generated Files</h4>
                            <div id="cpp-file-list" class="file-list">
                                <div class="no-files-message">No C++ files generated yet. Use @gen_cpp decorator on functions.</div>
                            </div>
                        </div>
                        <div class="cpp-file-viewer">
                            <div class="cpp-file-header">
                                <span id="cpp-file-name">Select a file</span>
                            </div>
                            <div id="cpp-file-content" class="cpp-editor-container">
                                <div class="cpp-placeholder">Select a C++ file from the list to view its content.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Mobile Overlay -->
        <div id="mobile-overlay" class="mobile-overlay"></div>

        <!-- About Modal -->
        <div id="about-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>About MADOLA</h2>
                    <button id="modal-close" class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <p><strong>MADOLA</strong> (Math Domain Language) is a specialized language for mathematical computations and documentation.</p>
                    <p>Features:</p>
                    <ul>
                        <li>Function definitions and calls</li>
                        <li>Variable assignments</li>
                        <li>Mathematical expressions</li>
                        <li>HTML output with LaTeX math rendering</li>
                    </ul>
                    <p>Built with WebAssembly for high performance in the browser.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- File input for opening files -->
    <input type="file" id="file-input" accept=".mda,.txt" style="display: none;">

    <!-- Load MADOLA application files in correct sequence -->
    <script src="js/app-sidebar.js"></script>
    <script src="js/app-core.js"></script>
    <script src="js/app-execution.js"></script>
    <script src="js/app-ui.js"></script>
    <script src="js/app-file-browser.js"></script>
    <script src="js/app.js"></script>
</body>
</html>